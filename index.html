<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taya Navi</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
:root{
  --bg:#0f1117;
  --card:#171a23;
  --text:#eaeef3;
  --border:#2a2f3c;
  --green:#1bb76e; /* Generate */
  --blue:#2f5eff;  /* Open */
}
.light{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#111;
  --border:#d0d6e2;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic",sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:30px;
}
.container{max-width:1000px;margin:auto}
.card{
  background:var(--card);
  padding:20px;
  border-radius:14px;
  margin-bottom:20px;
}
textarea,select{
  width:100%;
  background:var(--bg);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  margin-top:6px;
}
button{
  padding:6px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  cursor:pointer;
  margin-right:8px;
}
.btn-generate{background:var(--green);color:white;border:none;}
.btn-open{background:var(--blue);color:white;border:none;}
.btn-copy{background:transparent;color:var(--text);}
.group{
  margin-bottom:15px;
  position:relative;
}
.remove-btn{
  position:absolute;
  right:0;
  top:0;
  font-size:12px;
  cursor:pointer;
  opacity:.65;
}
.footer{
  margin-top:30px;
  font-size:11px;
  opacity:.35;
  word-break:break-all;
}
.history-item{
  font-size:12px;
  border:1px solid var(--border);
  padding:8px;
  border-radius:8px;
  margin-bottom:8px;
}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
}
.toggle{cursor:pointer;opacity:.7;}
.small{font-size:12px;opacity:.65;margin-top:6px}
hr{margin:18px 0;opacity:.2}
</style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <h2 id="ui_title">Taya Navi v3.3</h2>
    <div class="controls">
      <select id="lang" aria-label="Language">
        <option value="en" selected>English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="zh">‰∏≠Êñá</option>
      </select>
      <div class="toggle" id="ui_theme" onclick="toggleTheme()">üåô / ‚òÄ</div>
    </div>
  </div>

  <div class="card">
    <label><b id="ui_company_label">Company Names</b></label>
    <textarea id="companies" placeholder="Sunpower, Eaton / Ricor Systems"></textarea>
    <div class="small" id="ui_company_hint">
      Delimiters supported: comma, Japanese '„ÄÅ', middle dot '„Éª', slash '/', colon ':', semicolon ';', newline.
    </div>

    <label style="margin-top:14px;"><b id="ui_mode_label">Mode</b></label>
    <select id="mode">
      <option value="PAST" id="ui_mode_past">Former only (exclude current)</option>
      <option value="CURRENT" id="ui_mode_current">Current only</option>
      <option value="BOTH" id="ui_mode_both">Both (Current + Past)</option>
    </select>

    <hr>

    <div id="keywordContainer"></div>
    <button id="ui_add_group" onclick="addKeywordGroup()">+ Add Keyword Group (AND)</button>
    <div class="small" id="ui_kw_hint">
      Inside each group: OR. Between groups: AND. Example: (A OR B) AND (C OR D)
    </div>

    <br><br>

    <button class="btn-generate" id="ui_btn_generate" onclick="generate()">Generate</button>
    <button class="btn-open" id="ui_btn_open" onclick="openURL()">Open</button>
    <button class="btn-copy" id="ui_btn_copy" onclick="copyURL()">Copy</button>
  </div>

  <div class="card">
    <h3 id="ui_exp_companies">Expanded Companies</h3>
    <textarea id="expandedCompanies" readonly></textarea>

    <h3 id="ui_exp_keywords" style="margin-top:14px;">Expanded Keywords</h3>
    <textarea id="expandedKeywords" readonly></textarea>
  </div>

  <div class="card">
    <h3 id="ui_history_title">Recent Searches</h3>
    <div id="historyList"></div>
    <button id="ui_clear_history" onclick="clearHistory()">Clear All</button>
  </div>

  <div class="footer" id="urlFooter"></div>

</div>

<script>
/* ========= i18n ========= */
const i18n = {
  en: {
    title: "Taya Navi v3.3",
    companyLabel: "Company Names",
    companyHint: "Delimiters supported: comma, Japanese '„ÄÅ', middle dot '„Éª', slash '/', colon ':', semicolon ';', newline.",
    modeLabel: "Mode",
    modePast: "Former only (exclude current)",
    modeCurrent: "Current only",
    modeBoth: "Both (Current + Past)",
    addGroup: "+ Add Keyword Group (AND)",
    kwHint: "Inside each group: OR. Between groups: AND. Example: (A OR B) AND (C OR D)",
    btnGenerate: "Generate",
    btnOpen: "Open",
    btnCopy: "Copy",
    expCompanies: "Expanded Companies",
    expKeywords: "Expanded Keywords",
    historyTitle: "Recent Searches",
    clearAll: "Clear All",
    remove: "Remove",
    kwGroup: (n)=>`Keyword Group (${n})`,
    placeholderCompany: "Sunpower, Eaton / Ricor Systems",
    placeholderKw: "Ë≥ºË≤∑, Sales / procurement"
  },
  ja: {
    title: "Taya Navi v3.3",
    companyLabel: "‰ºöÁ§æÂêç",
    companyHint: "Âå∫Âàá„ÇäÊñáÂ≠ó: , / „ÄÅ / „Éª / / / : / ; / ÊîπË°åÔºà„Å©„Çå„Åß„ÇÇOKÔºâ",
    modeLabel: "„É¢„Éº„Éâ",
    modePast: "ÂâçËÅ∑„ÅÆ„ÅøÔºàÁèæËÅ∑„ÇíÈô§Â§ñÔºâ",
    modeCurrent: "ÁèæËÅ∑„ÅÆ„Åø",
    modeBoth: "ÁèæËÅ∑ + ÂâçËÅ∑",
    addGroup: "+ „Ç≠„Éº„ÉØ„Éº„Éâ„Ç∞„É´„Éº„Éó„ÇíËøΩÂä†ÔºàANDÔºâ",
    kwHint: "Âêå‰∏Ä„Ç∞„É´„Éº„ÉóÂÜÖ„ÅØ OR„ÄÅ„Ç∞„É´„Éº„ÉóÈñì„ÅØ AND „Åß„Åô„ÄÇÔºàA OR BÔºâANDÔºàC OR DÔºâ",
    btnGenerate: "ÁîüÊàê",
    btnOpen: "Èñã„Åè",
    btnCopy: "„Ç≥„Éî„Éº",
    expCompanies: "Â±ïÈñãÂæå„ÅÆ‰ºöÁ§æÂêç",
    expKeywords: "Â±ïÈñãÂæå„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ",
    historyTitle: "Â±•Ê≠¥ÔºàÊúÄËøëÔºâ",
    clearAll: "ÂÖ®„Å¶ÂâäÈô§",
    remove: "ÂâäÈô§",
    kwGroup: (n)=>`„Ç≠„Éº„ÉØ„Éº„Éâ„Ç∞„É´„Éº„ÉóÔºà${n}Ôºâ`,
    placeholderCompany: "‰æãÔºâSunpower„ÄÅEaton / Ricor Systems",
    placeholderKw: "‰æãÔºâË≥ºË≤∑„ÄÅSales / Ë™øÈÅî"
  },
  zh: {
    title: "Taya Navi v3.3",
    companyLabel: "ÂÖ¨Âè∏Âêç",
    companyHint: "ÊîØÊåÅÂàÜÈöîÁ¨¶ÔºöÈÄóÂè∑„ÄÅÈ°øÂè∑‚Äú„ÄÅ‚Äù„ÄÅ‰∏≠ÁÇπ‚Äú„Éª‚Äù„ÄÅÊñúÊù†‚Äú/‚Äù„ÄÅÂÜíÂè∑‚Äú:‚Äù„ÄÅÂàÜÂè∑‚Äú;‚Äù„ÄÅÊç¢Ë°å„ÄÇ",
    modeLabel: "Ê®°Âºè",
    modePast: "‰ªÖÂâçÂÖ¨Âè∏ÔºàÊéíÈô§‰ªçÂú®ËÅåÔºâ",
    modeCurrent: "‰ªÖÁé∞ÂÖ¨Âè∏",
    modeBoth: "Áé∞ÂÖ¨Âè∏ + ÂâçÂÖ¨Âè∏",
    addGroup: "+ Ê∑ªÂä†ÂÖ≥ÈîÆËØçÁªÑÔºàANDÔºâ",
    kwHint: "Âêå‰∏ÄÁªÑÂÜÖÊòØ ORÔºå‰∏çÂêåÁªÑ‰πãÈó¥ÊòØ AND„ÄÇ‰æãÂ¶ÇÔºö(A OR B) AND (C OR D)",
    btnGenerate: "ÁîüÊàê",
    btnOpen: "ÊâìÂºÄ",
    btnCopy: "Â§çÂà∂",
    expCompanies: "Ëß£ÊûêÂêéÁöÑÂÖ¨Âè∏Âêç",
    expKeywords: "Ëß£ÊûêÂêéÁöÑÂÖ≥ÈîÆËØç",
    historyTitle: "ÊúÄËøëËÆ∞ÂΩï",
    clearAll: "ÂÖ®ÈÉ®Ê∏ÖÁ©∫",
    remove: "Âà†Èô§",
    kwGroup: (n)=>`ÂÖ≥ÈîÆËØçÁªÑÔºà${n}Ôºâ`,
    placeholderCompany: "‰æãÔºöSunpower„ÄÅEaton / Ricor Systems",
    placeholderKw: "‰æãÔºöË≥ºË≤∑, Sales / procurement"
  }
};

function applyLang(lang){
  const t = i18n[lang] || i18n.en;
  document.getElementById("ui_title").innerText = t.title;
  document.getElementById("ui_company_label").innerText = t.companyLabel;
  document.getElementById("ui_company_hint").innerText = t.companyHint;
  document.getElementById("ui_mode_label").innerText = t.modeLabel;
  document.getElementById("ui_mode_past").innerText = t.modePast;
  document.getElementById("ui_mode_current").innerText = t.modeCurrent;
  document.getElementById("ui_mode_both").innerText = t.modeBoth;
  document.getElementById("ui_add_group").innerText = t.addGroup;
  document.getElementById("ui_kw_hint").innerText = t.kwHint;
  document.getElementById("ui_btn_generate").innerText = t.btnGenerate;
  document.getElementById("ui_btn_open").innerText = t.btnOpen;
  document.getElementById("ui_btn_copy").innerText = t.btnCopy;
  document.getElementById("ui_exp_companies").innerText = t.expCompanies;
  document.getElementById("ui_exp_keywords").innerText = t.expKeywords;
  document.getElementById("ui_history_title").innerText = t.historyTitle;
  document.getElementById("ui_clear_history").innerText = t.clearAll;

  document.getElementById("companies").placeholder = t.placeholderCompany;

  // refresh group labels/buttons/placeholders
  renumberGroups();
  keywordGroups.forEach(id=>{
    const ta = document.getElementById(id);
    if (ta) ta.placeholder = t.placeholderKw;
  });
}

/* ========= Core ========= */
const SPLIT_REGEX=/[\r\n,Ôºå„ÄÅ„ÄÇ:Ôºö„Éª\/\\;Ôºõ]+/g; // includes Chinese full stop for convenience
const MAX_GROUPS=4;
const MAX_HISTORY=10;
const LS_KEY="tayaHistory_v33";
const LS_LANG="tayaLang_v33";

let keywordGroups=[];
let generatedURL="";

function uniq(arr){
  return [...new Set(arr.map(x=>x.trim()).filter(Boolean))];
}

// NOTE: LinkedIn wants double-encoding and ALSO parentheses encoded.
// encodeURIComponent does NOT encode '(' ')' by default => we fix it.
function encForKeywords(raw){
  // 1) encodeURIComponent (unicode -> %E3... etc)
  // 2) force-encode parentheses
  // 3) double-encode by turning % -> %25
  const once = encodeURIComponent(raw)
    .replace(/\(/g, "%28")
    .replace(/\)/g, "%29");
  return once.replace(/%/g, "%25");
}

function encForCompany(raw){
  // company values live inside query(...) too; double-encode only is enough
  const once = encodeURIComponent(raw);
  return once.replace(/%/g, "%25");
}

function formatGroup(raw){
  const list = uniq((raw||"").split(SPLIT_REGEX));
  if(!list.length) return "";

  return list.map(k=>{
    // Chinese/Japanese/Korean chars -> use curly quotes like your example
    if(/[\u4e00-\u9fff]/.test(k)) return `‚Äú${k}‚Äù`;
    return `"${k}"`;
  }).join(" OR ");
}

function buildFilters(names, mode){
  function values(list, type){
    return list.map(n=>`(text%3A${encForCompany(n)}%2CselectionType%3A${type})`).join("%2C");
  }
  if(mode==="PAST"){
    return `(type%3APAST_COMPANY%2Cvalues%3AList(${values(names,"INCLUDED")}))%2C(type%3ACURRENT_COMPANY%2Cvalues%3AList(${values(names,"EXCLUDED")}))`;
  }
  if(mode==="CURRENT"){
    return `(type%3ACURRENT_COMPANY%2Cvalues%3AList(${values(names,"INCLUDED")}))`;
  }
  return `(type%3APAST_COMPANY%2Cvalues%3AList(${values(names,"INCLUDED")}))%2C(type%3ACURRENT_COMPANY%2Cvalues%3AList(${values(names,"INCLUDED")}))`;
}

function generate(){
  const companies=document.getElementById("companies").value;
  const mode=document.getElementById("mode").value;

  const names = uniq((companies||"").split(SPLIT_REGEX));
  document.getElementById("expandedCompanies").value = names.join("\n");

  const filters = buildFilters(names, mode);

  // Build keyword boolean: (g1) AND (g2) ...
  const groupsFormatted = keywordGroups
    .map(id => formatGroup(document.getElementById(id)?.value || ""))
    .filter(Boolean);

  const keywordString = groupsFormatted.map(g => `(${g})`).join(" AND ");
  document.getElementById("expandedKeywords").value = keywordString;

  const keywordBlock = keywordString ? `%2Ckeywords%3A${encForKeywords(keywordString)}` : "";

  const query = `(spellCorrectionEnabled%3Atrue%2CrecentSearchParam%3A(doLogHistory%3Atrue)%2Cfilters%3AList(${filters})${keywordBlock})`;
  generatedURL = `https://www.linkedin.com/sales/search/people?query=${query}&viewAllFilters=true`;

  document.getElementById("urlFooter").innerText = generatedURL;

  saveHistory();
}

function copyURL(){
  if(generatedURL) navigator.clipboard.writeText(generatedURL);
}

function openURL(){
  if(generatedURL) window.open(generatedURL,"_blank","noopener,noreferrer");
}

/* ========= Keyword groups ========= */
function addKeywordGroup(value=""){
  if(keywordGroups.length>=MAX_GROUPS) return;

  const id = "kw" + Date.now() + Math.floor(Math.random()*1000);
  keywordGroups.push(id);

  const div=document.createElement("div");
  div.className="group";
  div.innerHTML=`
    <label><b class="kw-label"></b></label>
    <span class="remove-btn" onclick="removeGroup('${id}')"></span>
    <textarea id="${id}"></textarea>
  `;
  document.getElementById("keywordContainer").appendChild(div);

  const ta = document.getElementById(id);
  ta.value = value;

  applyLang(document.getElementById("lang").value);
}

function removeGroup(id){
  keywordGroups = keywordGroups.filter(x=>x!==id);
  const ta = document.getElementById(id);
  if(ta && ta.parentElement) ta.parentElement.remove();
  renumberGroups();
}

function renumberGroups(){
  const lang = document.getElementById("lang").value;
  const t = i18n[lang] || i18n.en;

  const groups = document.querySelectorAll("#keywordContainer .group");
  groups.forEach((g, idx)=>{
    const label = g.querySelector(".kw-label");
    const rm = g.querySelector(".remove-btn");
    if(label) label.innerText = t.kwGroup(idx+1);
    if(rm) rm.innerText = t.remove;
  });
}

/* ========= History ========= */
function saveHistory(){
  if(!generatedURL) return;

  const history = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  history.unshift({
    companies: document.getElementById("companies").value,
    mode: document.getElementById("mode").value,
    keywords: keywordGroups.map(id => document.getElementById(id)?.value || ""),
    url: generatedURL,
    time: new Date().toLocaleString()
  });

  const trimmed = history.slice(0, MAX_HISTORY);
  localStorage.setItem(LS_KEY, JSON.stringify(trimmed));
  renderHistory();
}

function renderHistory(){
  const history = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  const container = document.getElementById("historyList");
  container.innerHTML = "";

  const lang = document.getElementById("lang").value;
  const t = i18n[lang] || i18n.en;

  history.forEach((item, idx)=>{
    const div = document.createElement("div");
    div.className="history-item";
    div.innerHTML = `
      <b>${item.time}</b><br>
      <div style="opacity:.75; margin-top:4px; white-space:pre-wrap;">${escapeHtml(item.companies)}</div>
      <div style="margin-top:8px;">
        <button onclick="loadHistory(${idx})">${lang==="ja" ? "Ë™≠„ÅøËæº„Åø" : lang==="zh" ? "ËΩΩÂÖ•" : "Load"}</button>
        <button onclick="deleteHistory(${idx})">${lang==="ja" ? "ÂâäÈô§" : lang==="zh" ? "Âà†Èô§" : "Delete"}</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function loadHistory(idx){
  const history = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  const item = history[idx];
  if(!item) return;

  document.getElementById("companies").value = item.companies || "";
  document.getElementById("mode").value = item.mode || "PAST";

  // rebuild groups
  document.getElementById("keywordContainer").innerHTML = "";
  keywordGroups = [];
  (item.keywords || []).slice(0, MAX_GROUPS).forEach(v => addKeywordGroup(v));
  if(keywordGroups.length === 0) addKeywordGroup("");

  generatedURL = item.url || "";
  document.getElementById("urlFooter").innerText = generatedURL;

  // refresh expanded panels
  document.getElementById("expandedCompanies").value = uniq((item.companies||"").split(SPLIT_REGEX)).join("\n");
  const groupsFormatted = (item.keywords||[]).map(v=>formatGroup(v)).filter(Boolean);
  document.getElementById("expandedKeywords").value = groupsFormatted.map(g=>`(${g})`).join(" AND ");
}

function deleteHistory(idx){
  const history = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  history.splice(idx, 1);
  localStorage.setItem(LS_KEY, JSON.stringify(history));
  renderHistory();
}

function clearHistory(){
  localStorage.removeItem(LS_KEY);
  renderHistory();
}

function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* ========= Theme + init ========= */
function toggleTheme(){ document.body.classList.toggle("light"); }

document.getElementById("lang").addEventListener("change", (e)=>{
  const lang = e.target.value;
  localStorage.setItem(LS_LANG, lang);
  applyLang(lang);
  renderHistory();
});

// init
const savedLang = localStorage.getItem(LS_LANG) || "en";
document.getElementById("lang").value = savedLang;
applyLang(savedLang);

addKeywordGroup(""); // default 1 group
renderHistory();
</script>
</body>
</html>
